---
# Start of options to set
report_title: |
  Strait of Georgia Pacific Herring (*Clupea pallasii*) stock update in 2024
assess_yr: "2024"
report_year: "2025"
release_month: "January"
report_number: "XXX"
meeting_date: "September XX, 2024"
region: "Pacific Region"
phone: "(250) 555-5555"
email: "DFO.PacificCSA-CASPacifique.MPO@dfo-mpo.gc.ca"
csa_address: "3190 Hammond Bay Rd., Nanaimo, BC, V9T 6N7"
report_title_french: |
  Mise à jour du stock de hareng du Pacifique (*Clupea pallasii*)
  du détroit de Géorgie en 2024
inuktitut_citation: |
  Inuktitut citation here
# [Mandatory section; less than 150 words.]
context: |
  Pacific Herring (*Clupea pallasii*) abundance in British Columbia is assessed
  using a spatially integrated statistical catch at age model fit to
  spawn survey indices, fishery age composition data, and commercial catches.
  This stock assessment evaluates abundance relative to
  the limit reference point, the upper stock reference, and
  fisheries management objectives.
  [...]
  We recommend a management procedure for the
  Strait of Georgia stock assessment region.
output:
 csasdown::fsar_word
link-citations: false
bibliography: bib/refs.bib
# End of options to set
title: ""
knit: (function(input, ...) {
       csasdown::render_sar()
      })
always_allow_html: true
---

```{r libraries, echo = FALSE, message = FALSE}
# Add packages here
library(knitr)
library(rmarkdown)
library(tidyverse)
library(rosettafish)
library(csasdown)
library(here)
library(patchwork)
library(scales)
library(gfutilities)
library(kableExtra)

# library(gfiscamutils)
# library(herringutils)
source(("functions/ms3Rplots.R"))
source(("functions/ms3Rtools.R"))
source(("functions/ms3RrefPts.R"))
source(("functions/ms3Rstats.R"))

# first, load model histories
# projFolder is in "Outputs"
histFolder <- file.path("data","SOG_DDM_omGrid")

fitFolders <- c(  "fit_parBatSOG_MbhGrid_h.71",
                  "fit_parBatSOG_OMgrid_h.70_2",
                  "fit_parBatSOG_OMgrid_h.70_3",
                  "fit_parBatSOG_OMgrid_h.70_4",
                  "fit_parBatSOG_OMgrid_h.70_5")

fitPaths <- file.path(histFolder,fitFolders,paste0(fitFolders,".rds"))

histRpts <- lapply(X = fitPaths, FUN = readRDS)

scenarios <- c( "SOG_Mb0.532_h0.70",
                "SOG_Mb0.562_h0.65",
                "SOG_Mb0.562_h0.70",
                "SOG_Mb0.562_h0.75",
                "SOG_Mb0.584_h0.70")

names(histRpts) <- scenarios

# order hist reports
histRpts <- histRpts[c(3,2,4,1,5)]


simFolder <- file.path("data","SOG_wtdPerf_Ugrid")
# Now read the infoFile in each sim folder
dirList   <- list.dirs(simFolder, recursive = FALSE)
dirList   <- dirList[grepl(x = dirList, pattern = "sim_")]

infoList  <- file.path(dirList,"infoFile.txt")
infoList  <- lapply(X = infoList, FUN = lisread)
infoList  <- lapply(X = infoList, FUN = as.data.frame)
info.df   <- do.call(rbind, infoList)

mps   <- c("Ugrid_0.06","Ugrid_0.14")
mps2  <- c("maxTHR_0.06","maxTHR_0.14")

# Filter info.df
info.df <- info.df |> filter( mp %in% mps )
mpBlobList <- list()

for(k in 1:nrow(info.df))
{
  simLabel <- paste0("sim_",info.df$simLabel[k])
  path <- file.path(simFolder,simLabel,paste0(simLabel,".RData"))
  # Load blob
  load(path)

  # Save to mpBlobList
  mpBlobList[[k]] <- blob

}
names(mpBlobList) <- info.df$simLabel


fYear   <- blob$ctlList$opMod$fYear
nS      <- blob$om$nS
nP      <- blob$om$nP
nT      <- blob$om$nT
tMP     <- blob$om$tMP
pT      <- blob$ctlList$opMod$pT

isProj <- pT > 1

species <- blob$om$speciesNames
stock   <- blob$om$stockNames

goodRepIdx <- which(blob$goodRep)

# Draw a random replicate for plotting
set.seed(101)
randReplicate <- sample(goodRepIdx, size = 1)
randTraces    <- sample(goodRepIdx, size = 3)
usePosts      <- blob$ctlList$opMod$posteriorSamples

# Replace passed objectives with a filled circle dot 
# (use unicode??)
passObj <- function( X, target = .95, comp = "gt" )
{
  out <- character(length = length(X))
  for( l in 1:length(X))
  { 
    if( length(target) > 1 )
      tar <- target[l]
    else tar <- target

    if( comp == "gt")
    {
      if( round(X,2) >= tar )
        out[l] <- paste("$\\checkmark$")
      else out[l] <- paste(X,sep = "")
    }

    if( comp == "lt")
    {
      if( round(X,2) <= tar )
        out[l] <- paste("$\\checkmark$")
      else out[l] <- paste("$",X,">",target,"$",sep = "")
    }    

  }
  return(out)
}

```

```{r setup, echo = FALSE}
# Set knitr options
if (is_latex_output()) {
  knitr_figs_dir <- "knitr-figs-pdf/"
  knitr_cache_dir <- "knitr-cache-pdf/"
  fig_out_type <- "png"
  kable_format <- "latex"
} else {
  knitr_figs_dir <- "knitr-figs-docx/"
  knitr_cache_dir <- "knitr-cache-docx/"
  fig_out_type <- "png"
  kable_format <- "pandoc"
}

knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.path = "knitr-figs-docx/",
  fig.asp = 0.618,
  fig.width = 7,
  echo = FALSE,
  dev = "png",
  dpi = 180
)
```

```{r metadata}
# assess_yr <- metadata$assess_yr
assess_yr <- 2024
# meta_out <- metadata$output
# french <- meta_out$`csasdown::fsar_word`$french
french <- FALSE
```

```{r models}
models_dir <- here("models")
major_stock_dir <- list("SoG")
```

```{r scripts}
source(here("R", "models.R"))
source(here("R", "variables.R"))
source(here("R", "figures.R"))
source(here("R", "themes.R"))
# Theme for figures
theme_set(theme_herring())
```

<!-- Math expressions -->
\newcommand{\mli}[1]{\mathit{#1}}
\newcommand{\SB}{\mli{`r en2fr("SB", translate = french)`}}
\newcommand{\BR}{\mli{BR}}
\newcommand{\AVE}{\text{`r en2fr("AVE", translate = french)`}}

<!-- Compile the document on the command line: -->
<!-- bookdown::render_book("index.Rmd") -->
