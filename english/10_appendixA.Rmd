\clearpage
 

`r if(knitr:::is_latex_output()) '\\Appendices'`
 
`r if(!knitr:::is_latex_output()) '# (APPENDIX) Appendix {-}'`
 
# APPENDIX A {#app:a}

This appendix summarises closed loop simulations evaluating candidate
management procedures for the Strait of Georgia (SOG) herring fishery. SOG herring
is the first BC herring fishery to use the new herring operating model framework, 
named the Spatially Integrated Statistical Catch-at-Age Herring Operating Model 
(SISCAH-OM). Although there are several differences between SISCAH and the 
previous herring assessment and operating models, the main difference in SISCAH-OM
is the ability to model density dependent mortality (DDM), where 
natural mortality is higher when biomass is lower [@johnson2024].

All candidate MPs are tested against a suite of five 
SISCAH operating models, which incorporate uncertainty in future productivity 
at both low and high stock sizes. We first summarise the simulation approach,
and then present results weighted over the five operating 
models, with some brief discussion of the management implications.  

# Simulation approach


## Operating models

We define five SOG Herring operating models that test against
uncertainty in productivity at high and low stock sizes. Productivity
at high stock sizes is influenced by the $M_b$ parameter, which 
represents the average mortality rate at very high biomass (generally above 
unfished levels). At low stock size, productivity is more influenced by the 
stock-recruit relationship's steepness parameter $h$, which is the ratio of 
recruitment at 20\% of unfished to the unfished recruitment $R_0$. Overall $h$ 
is better estimated for stocks where the history includes recovery from very low stock 
sizes. Since this isn't case for SOG, we capture some of the uncertainty around 
$M_b$ and $h$ by considering operating models with different values for those parameters.
First we used an established value of $h=0.70$ [@cleary2019] 
and ran the operating model with a suite of $M_b$ values, examined the likelihood profiles
and determined that $M_b=0.562$ produced the lowest negative-log-likelihood.
We then ran operating models with $h$ values of 0.65 and 0.75, 
while keeping $M_b=0.562$.
Finally to round it out we considered models where $h=0.70$ and $M_b$ was 0.532 and 0.584
which correspond to values with equal likelihood values on either side of 
0.562 (Figure \@ref(fig:LPfig)). 

This creates a cross design (Table \@ref(tab:parRefPtsTable)) 
with a central OM (called OM1, $M_b=0.562$ and $h = 0.7$) which we gave a weight 
of 0.34. The remaining operating models are weighted equally   
with a weight of 0.165. This creates the situation where OM1's weight 
is the average of the weights of each axis in the cross design, 
with $h$ being uniform (i.e., 0.33) and the 
$M_b$ value's weight based on the relative data likelihood function value 
(i.e, around 0.35).

For all operating models, we report leading OM parameters, current biomass and 
stock status, and $MSY$ based reference points (Table \@ref(tab:parRefPtsTable)).

```{r parRefPtsTable, echo = FALSE, warnings = FALSE}
#This produces HTML output TODO: FIX to table format for word?
postParTable <- read.csv("data/omGrid_postPars.csv")
refPtsTable <- read.csv("data/SOG_allScenRefPts.csv")

postParTable$X <- NULL
refPtsTable$X <- NULL

allEstTable <- postParTable |> 
                left_join(refPtsTable, by = "Scenario") 
# reorder
allEstTable <- allEstTable[c(3,2,4,1,5),] |>
                dplyr::select(  h,
                                Mb,
                                B0, 
                                R0, 
                                M0,
                                m1,
                                Mbar,
                                qs,
                                BT,
                                DT = DT.x,
                                PBTGtLRP,
                                Bmsy,
                                Umsy,
                                MSY,
                                USR,
                                Uusr,
                                Yusr,
                                Ucrash) |>
                t()

colnames(allEstTable) <- c("OM1","OM2","OM3","OM4","OM5")

rownames(allEstTable) <- c( "$h$",
                            "$M_b$",
                            "$SB_0$",
                            "$R_0$",
                            "$M_0$",
                            "$m_1$",
                            "$\\overline{M}$",
                            "$q_s$",
                            "$SB_{2023}$",
                            "$SB_{2023}/SB_0$",
                            "$P(SB_{2023} > 0.3 SB_0)$",
                            "$SB_{MSY}$",
                            "$U_{MSY}$",
                            "$MSY$",
                            "$USR$",
                            "$U_{USR}$",
                            "$Y_{USR}$",
                            "$U_{Crash}$")

allEstTabCap <- "SISCAH-OM life-history and management parameter values for stock-recruit steepness ($h$), asymptotic lower limit on depensatory $M$ ($M_b$, /yr), unfished biomass ($SB_0$, kt), unfished recruitment ($R_0$, 1e6), unfished mortality ($M_0$, /yr), mortality depensation rate ($m_1$), time-averaged mortality ($\\overline{M}$, /yr), surface survey design catchability ($q_s$), spawning biomass in 2023 ($SB_{2023}/SB_0$), stock status ($P(SB_{2023} > 0.3 SB_0)$), spawning biomass at maximum sustainable yield ($SB_{MSY}$, kt), harvest rate targeting maximum sustainable yield ($U_{MSY}$), maximum sustainable yield ($MSY$), upper stock reference ($USR$, kt), harvest rate targeting the upper stock reference ($U_{USR}$), equilibrium yield at the upper stock reference ($Y_{USR}$), harvest rate associated with negative production and higher risk of extirpation ($U_{Crash}$). Uncertainty is shown as the 95\\% credible interval where estimates could be drawn from posterior samples (indicated by two parenthetical values), or half the interquartile range where estimates were drawn from 200 year simulations (one parenthetical value)."

kable(  allEstTable, escape = FALSE, 
        caption = allEstTabCap, booktabs = T,
        align = rep("r",5)) %>%
  kable_styling( latex_options = c("striped", "scale_down","hold_position"),
                 bootstrap_options = c("striped", "hover") )

```

```{r LPfig, echo = FALSE, fig.cap = LPfigCap }
LPfigCap <- "Fishery monitoring data likelihood function profiles relative to a range of natural mortality asymptotic lower limit ($M_b$) parameter values. The red point shows the most likely value, while the two vertical dashed lines show two values with equal likelihood chosen to bound the central OM1. All SISCAH model fits here have a steepness value of $h = 0.7$"
filepath <- "figure/LP_chooseMb.png"
knitr::include_graphics(filepath)

```

## Management Procedures

Management procedures are a combination of data, biomass estimation method (EM), 
and a harvest control rule (HCR). 

All MPs tested here use the same data. The EM, which is fit to 
those data, is a SISCAH model with a density independent $M$ (DIM) hypothesis, 
which uses a simple random walk to estimate time-varying $M$. The DIM hypothesis 
is similar to the previous model used for herring assessments and setting TACs, 
which used a spline instead of a simple random walk for estimating time-varying
$M$. The EM provides annual estimates of unfished biomass and a 1-year ahead 
forecast of spawning biomass.

TACs are derived from EM estimates via the harvest control rule. For
SOG herring, we use a "hockey-stick" shaped 
function with control points at 30\% and 60\% of unfished biomass. When spawning
biomass is estimated to be below the lower control point, the rule sets harvest
rates to zero; when biomass estimates are above the upper control point, the rule
sets harvest rates to the maximum target harvest rate, called $maxTHR$. We show
results for maximum target harvest rates of 6\% and 14\% (Figure \@ref(fig:hcrPlot)).



```{r hcrPlot, echo = FALSE, fig.cap = HCRcap}
HCRcap <- "Two harvest control rules tested for candidate SOG herring MPs, showing maximum target harvest rates $maxTHR$ of 6\\% and 14\\%."

plotHCRex(maxSeq = c(0.06,0.14))
```


## Performance metrics

MPs are evaluated against two quantitative management objectives, listed below.

1. $P(B_t > 0.3 B_0) \geq 0.75$, or **avoid the limit reference point (LRP) with high 
probability over three herring generations.**

2. $P(B_t > USR) \geq 0.5$, or **target the upper stock reference (USR) with neutral
probability**.

Objective 1, also known as the conservation objective, must be passed by
all herring management procedures. Objective 2 is a target objective related 
to a recently described provisional $USR$.

To help fishery managers understand trade-offs among biomass and yield, 
additional quantitative performance metrics are estimated. These metrics 
do not have a minimum or target value like objectives, but give greater 
detail on biomass and yield outcomes of each MP over the
15 year simulation.


1. $P(B_t > B_{MSY})$: The probability that biomass is above $B_{MSY}$.

1. $P(U_t > U_{MSY})$: The probability that the effective harvest rate
is above $U_{MSY}$. 

1. $P(C_t > 650 t)$: The probability of a viable fishery where catch is
greater than 650 tonnes.

1. $C_{5pc}$: Catch risk, measured as the fifth percentile of catch over all years and replicates.

1. $\overline{C}$: Median (over replicates) of the average (over years) total
landings.

1. $AAV$: Average annual variation in catch, or the mean percentage difference
in catch from year-to-year.

1. $C_{2024}$: The MP's TAC in 2024.

1. $\overline{B_{t}/B_0}$: Average biomass depletion from 2024 - 2038.

1. ${B_{2038}/B_0}$: Median biomass depletion in 2038.

1. $B_{2038}$: Median biomass in 2038.


<!-- Add average depletion -->

Performance metrics are estimated via closed loop feedback simulations
with the following simulation algorithm: 

1. For each Operating Model, initialize a pre-conditioned 
simulation model for the period 1951 – 2023 based on a random
draw from the operating model posterior distribution;

2.  Project the SOG Herring DDM operating model into the future one year 
at a time. For each year in the projection, apply the following:
      i)   Update the time series of commercial catch, catch-at-age, and blended 
      spawn survey data up to time-step t for the stock assessment component of the MP;
      ii)  Use an assessment model (the Density Independent $M$ SISCAH model) 
      to produce a 1-year ahead forecast of spawning biomass depletion;
      iii)  Determine the target harvest rate associated with the forecast 
      depletion using the HS 30-60 harvest control rule;
      iv)  Using this target harvest rate calculate the total allowable catch from the 1-year ahead biomass 
      forecast;
      v)  Update the simulated DDM operating model herring population in the with 
      incoming recruitment from the DDM stock-recruit curve with recruitment process errors; 
      density dependant natural mortality; and fishing mortality corresponding 
      to the total allowable catch in the previous step. 
      vi)   Repeat steps 2.i - 2.v until the projection period ends (2038).


3.  Repeat steps 1. and 2. 99 more times;

4.  Calculate quantitative performance statistics across all 
    100 replicates.


# Discussion

A fishery that meets Objective 1 could target a 13\% harvest rate with an 
average yield in the 10 - 11 kt range (Table \@ref(tab:statTable). If management
procedures are also targeting the USR (Objective 2), then harvest rates need
to drop to around 7\% (as predicted by the reference point estimates, Table 
\@ref(tab:parRefPtsTable)), and average catches would be closer to the 6 - 7 kt 
range. Any harvest rate above 13\%, including $U_{MSY}$ estimates for every
OM, do not meet either fishery objective. As such, meeting both fishery objectives
requires accepting that TACs will need to be lower in the future, in contrast
to the average of around 20 kt up to 2019. 

Harvest rates need to be much lower than $U_{MSY}$ to avoid the LRP with high 
probability (75\% or more). This is because the LRP is quite high relative to 
$B_{MSY}$ (Table \@ref(tab:parRefPtsTable), Figure \@ref(fig:simEnv)), 
roughly around 70\% of $B_{MSY \vert OM1}$ for OM1. For comparison, the default
limit reference point in Canadian fisheries policy is 40\% of $B_{MSY}$
or some proxy, although this is largely applied to longer lived groundfish
species with less variable recruitment and lower predation pressures.

The EM based on the Density Independent $M$ model appears to overestimate 
biomass in the 1-year ahead forecast. So called positive assessment errors are 
reflected in the higher than neutral probability the effective harvest rates exceed
the maximum target harvest rate (Table \@ref(tab:statTable), $P(U_t > U_{ref})$,
Figure \@ref(fig:simEnv), bottom row). As such, MPs should aim for slightly 
lower maximum harvest rates than the biomass target implies. For example,
reference points imply a harvest rate of around 8\% (weighted over OMs) to
achieve the USR target in the long term, but positive assessment errors mean
that MPs should target closer to 7\%.

The metrics for the probability of a viable fishery and the 5th percentile of 
simulated TACs are closely related (Table \@ref(tab:statTable), $C_t > 650 t$
and $C_{5pc}$). Each shows that increasing harvest rates generally means accepting 
a higher proportion of years with low catch. Additionally, both metrics appear to 
show an optimal range of 4\% - 6\% harvest rates where the risk of poor fishing 
is lowest. The $C_{5pc}$ column is more informative, however, as it uses absolute 
landings estimates that have a broader range than the more intangible probability 
of viable fishing.




```{r, statTable, echo = FALSE }
#This produces HTML output TODO: FIX to table format for word?
wtdPerfTable <- read.csv("data/wtdTable.csv")

statTable <- wtdPerfTable |>
              filter( mp %in% mps2 ) |>
              mutate_if(is.numeric, round, 2) |>
              dplyr::select(  mp,
                              pBtGt.3B0,
                              pBtGtBmsy,
                              pBtGtUSR,
                              pUtGtUmsy,
                              pCtGt650t,
                              C5pc,
                              avgCatch_t,
                              catchAAV,
                              CtMP,
                              aveDep, 
                              DnT,
                              BnT ) |>
              mutate( avgCatch_t = round(avgCatch_t/1e3,2),
                      pBtGt.3B0 = sapply(X = pBtGt.3B0, FUN = passObj, target = .75),
                      pBtGtUSR  = sapply(X = pBtGtUSR, FUN = passObj, target = .5) )

colnames(statTable) <- c( "MP",
                          "$B_t \\geq 0.3 B_0$",
                          "$B_t \\geq B_{MSY}$",
                          "$B_t \\geq USR$",
                          "$U_t \\geq U_{MSY}$", # Replace with Umsy
                          "$C_t \\geq 650 t$",
                          "$C_{5pc}$",
                          "$\\overline{C}$",
                          "$AAV$",
                          "$C_{2024}$",
                          "$\\overline{B_{t}/B_0}$", 
                          "$B_{2038}/B_0$",
                          "$B_{2038}$"
                          )

statTabCap <- "Performance statistics for the selected harvest rates. Objectives that are passed by an MP are indicated by a bullet. Conservation, Biomass, Overfishing, and Viable Fishery metrics are all in probability units. Catch at Risk 5\\%, Average Catch, 2024 Catch and Final Biomass are all in biomass units (kt), and Stock Status is biomass depletion relative to unfished (proportion)."

# criteria <- c( " " = 1,
#                "P > .75" = 1,
#                "Obs < Acc" = 1,
#                "P > .5" = 1,
#                "min" = 1,
#                "max" = 1,
#                " " = nOtherCols)

# typeNames <- c( " " = 1,
                
#                 "Catch metrics" = 5,


objNames <- c(  " " = 1,
                "Conservation" = 1,
                "Biomass" = 2,
                "Overfishing" = 1,
                "Viable Fishery" = 1,
                "Catch at Risk 5\\% " = 1,
                "Average Catch" = 1,
                "Catch Variability" = 1,
                "2024 Catch" = 1,
                "Stock Status" = 2,
                "Final Biomass" = 1)



# objNames <- c(" " = 1,
#               "Objective 1" = 1,
#               "Objective 2" = 1,
#               "Objective 3" = 1,
#               "Objective 4" = 1,
#               "Objective 5" = 1,
#               "Other Important Quantities" = nOtherCols )


kable(  statTable, escape = FALSE, 
        caption = statTabCap, booktabs = T,
        align = c(rep("c",ncol(statTable)))) %>%
  kable_styling( latex_options = c("striped", "scale_down","hold_position"),
                 bootstrap_options = c("striped", "hover") ) |>
  add_header_above( objNames, bold = T ) #|>
  # add_header_above( typeNames, bold = T ) 

```


```{r, captions, include = FALSE, echo = FALSE}
multiGridTulipCap <- "Simulation envelopes of spawning biomass depletion (top row), catch (middle row) 
and effective harvest rate (bottom row). Each column shows a single MP, labeled in the
top margin. Median values are shown by the thick black lines, the grey 
shaded region shows the central 95% of each envelope, and three randomly selected
individual replicate traces are shown as thin black lines."

```

```{r simEnv, echo = FALSE, fig.cap = multiGridTulipCap}
plotGridTulipBtCtUt(mpBlobList,
                    labels = mps2,
                    yLimC = c(0,20),
                    yLimHR = c(0,0.4))
```
# Exceptional Circumstances

Fishery monitoring data collected since the adoption of the current SOG
herring MP does is within expectations. In formal language, there is no
indication of exceptional circumstances (Figure \@ref(fig:ECfig)),
measured by catch and spawn index values within the expected range of
previous closed loop simulations.


```{r ECfig, echo = FALSE, fig.cap = ECfigCap }
ECfigCap <- "A graphical test for exceptional circumstances, showing the central 95\\% of projected spawn index values (top) and catch values (bottom) using the 2019 SOG operating model, with realised data in the history (black points) and projection (red points) overlaid."
filepath <- "figure/ExceptionalCircumstances.png"
knitr::include_graphics(filepath)

```





